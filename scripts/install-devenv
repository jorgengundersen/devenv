#!/bin/bash
set -euo pipefail

# install-devenv - Installation script for containerized development environment

# --- Constants ---
DEVENV_HOME="${DEVENV_HOME:-$(
    script_path="${BASH_SOURCE[0]}"
    if command -v readlink >/dev/null 2>&1; then
        script_path=$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || printf '%s' "${BASH_SOURCE[0]}")
    fi
    script_dir=$(cd "$(dirname "${script_path}")" && pwd)
    cd "${script_dir}/.." && pwd
)}"
readonly DEVENV_HOME
readonly LOCAL_BIN="${HOME}/.local/bin"

# --- Logging ---
# shellcheck disable=SC1091
. "${DEVENV_HOME}/shared/bash/log.sh"

# --- Primitives ---
# Print usage information.
usage() {
    cat << EOF
Usage: install-devenv [OPTIONS]

Install devenv scripts by creating symlinks in ~/.local/bin/.

Options:
    --help, -h          Show this help message
    --source, -s        Repository root (default: repository root containing this script)
    --uninstall         Remove symlinks (uninstall)

The following symlinks will be created:
    ~/.local/bin/build-devenv -> <source>/bin/build-devenv
    ~/.local/bin/devenv -> <source>/bin/devenv

Note: Ensure ~/.local/bin is in your PATH.
EOF
}

# --- Commands ---
# Create symlinks.
install_devenv() {
    local source_dir="$1"
    log_info "Installing devenv..."

    if [[ ! -d "${LOCAL_BIN}" ]]; then
        log_info "Creating ${LOCAL_BIN}..."
        mkdir -p "${LOCAL_BIN}"
    fi

    if [[ ! -f "${source_dir}/bin/build-devenv" ]]; then
        die "build-devenv script not found at ${source_dir}/bin/build-devenv"
    fi
    if [[ ! -f "${source_dir}/bin/devenv" ]]; then
        die "devenv script not found at ${source_dir}/bin/devenv"
    fi

    local build_devenv_link="${LOCAL_BIN}/build-devenv"
    local devenv_link="${LOCAL_BIN}/devenv"

    if [[ -L "${build_devenv_link}" ]]; then
        log_info "Removing existing symlink: ${build_devenv_link}"
        rm "${build_devenv_link}"
    elif [[ -e "${build_devenv_link}" ]]; then
        die "File already exists (not a symlink): ${build_devenv_link}"
    fi

    if [[ -L "${devenv_link}" ]]; then
        log_info "Removing existing symlink: ${devenv_link}"
        rm "${devenv_link}"
    elif [[ -e "${devenv_link}" ]]; then
        die "File already exists (not a symlink): ${devenv_link}"
    fi

    log_info "Creating symlink: ${build_devenv_link}"
    ln -s "${source_dir}/bin/build-devenv" "${build_devenv_link}"

    log_info "Creating symlink: ${devenv_link}"
    ln -s "${source_dir}/bin/devenv" "${devenv_link}"

    log_info "Installation completed successfully!"
    log_info "Available commands: build-devenv, devenv"

    if [[ ":${PATH}:" != *":${LOCAL_BIN}:"* ]]; then
        log_warning "${LOCAL_BIN} is not in your PATH."
        log_warning "Add the following to your shell configuration:"
        log_warning "  export PATH=\"\${HOME}/.local/bin:\${PATH}\""
    fi
}

# Remove symlinks (uninstall).
uninstall_devenv() {
    log_info "Uninstalling devenv..."

    local build_devenv_link="${LOCAL_BIN}/build-devenv"
    local devenv_link="${LOCAL_BIN}/devenv"

    if [[ -L "${build_devenv_link}" ]]; then
        log_info "Removing symlink: ${build_devenv_link}"
        rm "${build_devenv_link}"
    else
        log_info "Symlink not found: ${build_devenv_link}"
    fi

    if [[ -L "${devenv_link}" ]]; then
        log_info "Removing symlink: ${devenv_link}"
        rm "${devenv_link}"
    else
        log_info "Symlink not found: ${devenv_link}"
    fi

    log_info "Uninstallation completed successfully!"
}

# --- Entrypoint ---
# Dispatch install or uninstall operations.
main() {
    local source_dir="${DEVENV_HOME}"
    local do_uninstall=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --help|-h)
                usage
                return
                ;;
            --uninstall)
                do_uninstall=true
                shift
                ;;
            --source|-s)
                if [[ -z "${2:-}" ]]; then
                    die "Option $1 requires a path"
                fi
                source_dir="$2"
                shift 2
                ;;
            *)
                die "Unknown option: $1"
                ;;
        esac
    done

    if "${do_uninstall}"; then
        uninstall_devenv
        return
    fi

    install_devenv "${source_dir}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
