#!/bin/bash
set -euo pipefail

# build-devenv - Build management script for containerized development environment

# --- Constants ---
DEVENV_HOME="${DEVENV_HOME:-$(
    script_path="${BASH_SOURCE[0]}"
    if command -v readlink >/dev/null 2>&1; then
        script_path=$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || printf '%s' "${BASH_SOURCE[0]}")
    fi
    script_dir=$(cd "$(dirname "${script_path}")" && pwd)
    cd "${script_dir}/.." && pwd
)}"
readonly DEVENV_HOME
readonly IMAGE_PREFIX="devenv"

# --- Logging ---
# shellcheck disable=SC1091
. "${DEVENV_HOME}/shared/bash/log.sh"

# --- Primitives ---
# Print usage information.
usage() {
    cat << EOF
Usage: build-devenv [OPTIONS]

Build containerized development environment images.

Options:
    --stage <stage>      Build a stage image
                         Valid stages: base, devenv-base, devenv
    --tool <tool>        Build specific tool Dockerfile
                         Valid tools: cargo, common-utils, copilot-cli, fnm, fzf, gh, go, jq, node, nvim, opencode, ripgrep, starship, tree-sitter, uv, yq
    --project <path>     Build project-specific image from .devenv/Dockerfile
    --help               Show this help message

Examples:
    build-devenv --stage base
    build-devenv --stage devenv-base
    build-devenv --stage devenv
    build-devenv --tool common-utils
    build-devenv --tool nvim
    build-devenv --project ./my-project

Note: The build context defaults to the repository root.
    Override with DEVENV_HOME=/path/to/repo.
EOF
}

# Validate Docker availability and daemon state.
validate_docker() {
    if ! command -v docker >/dev/null 2>&1; then
        log_error "Docker is not installed or not in PATH"
        return 1
    fi
    if ! docker info >/dev/null 2>&1; then
        log_error "Docker daemon is not running"
        return 1
    fi
}

# Resolve a path argument to a canonical absolute path.
resolve_project_path() {
    local raw_path="$1"
    local path

    if [[ "${raw_path}" == "." ]]; then
        path="${PWD}"
    elif [[ "${raw_path}" == /* ]]; then
        path="${raw_path}"
    else
        path="${PWD}/${raw_path}"
    fi

    if [[ ! -d "${path}" ]]; then
        return 1
    fi

    path=$(cd "${path}" && pwd)
    printf '%s' "${path}"
}

# Derive a safe project image suffix from path.
derive_project_image_suffix() {
    local project_path="$1"
    local parent_name project_name raw_name safe_name

    parent_name="${project_path%/*}"
    parent_name="${parent_name##*/}"
    project_name="${project_path##*/}"
    raw_name="${parent_name}-${project_name}"
    safe_name=$(printf '%s' "${raw_name}" | sed 's/[^a-zA-Z0-9_.-]/-/g')
    safe_name=$(printf '%s' "${safe_name}" | sed 's/^[^a-zA-Z0-9]//')
    if [[ -z "${safe_name}" ]]; then
        return 1
    fi
    printf '%s' "${safe_name}"
}

# --- Commands ---
# Build the repo-base image (shared foundation).
build_stage_repo_base() {
    log_info "Building repo-base image..."

    local dockerfile="${DEVENV_HOME}/docker/base/Dockerfile.base"
    if [[ ! -f "${dockerfile}" ]]; then
        die "Repo-base Dockerfile not found: ${dockerfile}"
    fi

    local version
    version=$(date +%Y%m%d.%H%M%S)

    log_info "Building repo-base:${version}..."
    docker build \
        -f "${dockerfile}" \
        -t "repo-base:${version}" \
        -t "repo-base:latest" \
        "${DEVENV_HOME}"

    log_info "Repo-base image built successfully: repo-base:${version}"
}

# Build the devenv-base image (SSH layer on top of repo-base).
build_stage_devenv_base() {
    log_info "Building devenv-base image..."

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^repo-base:latest$"; then
        log_info "Repo-base image not found, building first..."
        build_stage_repo_base
    fi

    local dockerfile="${DEVENV_HOME}/docker/devenv/Dockerfile.base"
    if [[ ! -f "${dockerfile}" ]]; then
        die "Devenv-base Dockerfile not found: ${dockerfile}"
    fi

    local version
    version=$(date +%Y%m%d.%H%M%S)

    log_info "Building ${IMAGE_PREFIX}-base:${version}..."
    docker build \
        -f "${dockerfile}" \
        -t "${IMAGE_PREFIX}-base:${version}" \
        -t "${IMAGE_PREFIX}-base:latest" \
        "${DEVENV_HOME}"

    log_info "Devenv-base image built successfully: ${IMAGE_PREFIX}-base:${version}"
}

# Build the devenv image (complete environment).
build_stage_devenv() {
    log_info "Building devenv image..."

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^repo-base:latest$"; then
        log_info "Repo-base image not found, building first..."
        build_stage_repo_base
    fi

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${IMAGE_PREFIX}-base:latest$"; then
        log_info "Devenv-base image not found, building first..."
        build_stage_devenv_base
    fi

    local dockerfile="${DEVENV_HOME}/docker/devenv/Dockerfile.devenv"
    if [[ ! -f "${dockerfile}" ]]; then
        die "Devenv Dockerfile not found: ${dockerfile}"
    fi

    local version
    version=$(date +%Y%m%d.%H%M%S)

    log_info "Building ${IMAGE_PREFIX}:${version}..."
    docker build \
        -f "${dockerfile}" \
        -t "${IMAGE_PREFIX}:${version}" \
        -t "${IMAGE_PREFIX}:latest" \
        "${DEVENV_HOME}"

    log_info "Devenv image built successfully: ${IMAGE_PREFIX}:${version}"
}

# Build a specific tool image.
build_tool() {
    local tool="$1"
    local dockerfile="${DEVENV_HOME}/shared/tools/Dockerfile.${tool}"

    if [[ ! -f "${dockerfile}" ]]; then
        die "Tool Dockerfile not found: ${dockerfile}"
    fi

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^repo-base:latest$"; then
        log_info "Repo-base image not found, building first..."
        build_stage_repo_base
    fi

    if [[ "${tool}" == "tree-sitter" ]]; then
        if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^tools-node:latest$"; then
            log_info "Node tool image not found, building first..."
            build_tool "node"
        fi
    fi

    if [[ "${tool}" == "ripgrep" ]]; then
        if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^tools-jq:latest$"; then
            log_info "jq tool image not found, building first..."
            build_tool "jq"
        fi
    fi

    log_info "Building tool: ${tool}..."
    docker build \
        -f "${dockerfile}" \
        -t "tools-${tool}:latest" \
        "${DEVENV_HOME}"

    log_info "Tool image built successfully: tools-${tool}:latest"
}

# Build a project-specific image.
build_project() {
    local raw_path="$1"
    local project_path
    project_path=$(resolve_project_path "${raw_path}") || die "Project directory does not exist: ${raw_path}"

    local project_dockerfile="${project_path}/.devenv/Dockerfile"
    if [[ ! -f "${project_dockerfile}" ]]; then
        die "Project Dockerfile not found: ${project_dockerfile}"
    fi

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^repo-base:latest$"; then
        log_info "Repo-base image not found, building first..."
        build_stage_repo_base
    fi

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${IMAGE_PREFIX}-base:latest$"; then
        log_info "Devenv-base image not found, building first..."
        build_stage_devenv_base
    fi

    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${IMAGE_PREFIX}:latest$"; then
        log_info "Devenv image not found, building first..."
        build_stage_devenv
    fi

    local suffix
    suffix=$(derive_project_image_suffix "${project_path}") || die "Unable to derive project image tag"

    log_info "Building project image for: ${suffix}..."
    docker build \
        -f "${project_dockerfile}" \
        -t "${IMAGE_PREFIX}-project-${suffix}:latest" \
        "${project_path}"

    log_info "Project image built successfully: ${IMAGE_PREFIX}-project-${suffix}:latest"
}

# --- Entrypoint ---
# Dispatch top-level build operations.
main() {
    validate_docker || die "Docker is not available. Install Docker and try again."

    if [[ $# -eq 0 ]]; then
        usage
        die "No build options provided. Use --help for usage."
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --stage)
                shift
                if [[ $# -eq 0 ]]; then
                    die "--stage requires an argument (base, devenv-base, or devenv)"
                fi
                case "$1" in
                    base)
                        build_stage_repo_base
                        ;;
                    devenv-base)
                        build_stage_devenv_base
                        ;;
                    devenv)
                        build_stage_devenv
                        ;;
                    *)
                        die "Invalid stage: $1. Valid stages: base, devenv-base, devenv"
                        ;;
                esac
                shift
                ;;
            --tool)
                shift
                if [[ $# -eq 0 ]]; then
                    die "--tool requires an argument"
                fi
                build_tool "$1"
                shift
                ;;
            --project)
                shift
                if [[ $# -eq 0 ]]; then
                    die "--project requires a path argument"
                fi
                build_project "$1"
                shift
                ;;
            --help|-h)
                usage
                return
                ;;
            *)
                die "Unknown option: $1"
                ;;
        esac
    done

    log_info "Build completed successfully"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
